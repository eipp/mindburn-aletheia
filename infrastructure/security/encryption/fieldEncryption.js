"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.FieldEncryption = void 0;
const aws_sdk_1 = require("aws-sdk");
const crypto = require("crypto");
class FieldEncryption {
    constructor(keyId) {
        this.kms = new aws_sdk_1.KMS();
        this.keyId = keyId;
    }
    /**
     * Encrypts sensitive fields in an object using KMS and AES-256-GCM
     */
    async encryptFields(data, sensitiveFields) {
        const dataKey = await this.generateDataKey();
        const encryptedData = { ...data };
        for (const field of sensitiveFields) {
            if (field in data) {
                const encrypted = await this.encryptField(data[field], dataKey.Plaintext);
                encryptedData[field] = {
                    encrypted: encrypted.encryptedData,
                    iv: encrypted.iv.toString('base64'),
                    tag: encrypted.tag.toString('base64'),
                    encryptedKey: dataKey.CiphertextBlob.toString('base64'),
                };
            }
        }
        return encryptedData;
    }
    /**
     * Decrypts sensitive fields in an object using KMS and AES-256-GCM
     */
    async decryptFields(data, sensitiveFields) {
        const decryptedData = { ...data };
        for (const field of sensitiveFields) {
            if (field in data && typeof data[field] === 'object') {
                const encryptedField = data[field];
                const dataKey = await this.decryptDataKey(Buffer.from(encryptedField.encryptedKey, 'base64'));
                const decrypted = await this.decryptField(encryptedField.encrypted, dataKey, Buffer.from(encryptedField.iv, 'base64'), Buffer.from(encryptedField.tag, 'base64'));
                decryptedData[field] = decrypted;
            }
        }
        return decryptedData;
    }
    async generateDataKey() {
        return this.kms
            .generateDataKey({
            KeyId: this.keyId,
            KeySpec: 'AES_256',
        })
            .promise();
    }
    async decryptDataKey(encryptedKey) {
        const response = await this.kms
            .decrypt({
            CiphertextBlob: encryptedKey,
            KeyId: this.keyId,
        })
            .promise();
        return response.Plaintext;
    }
    async encryptField(data, key) {
        const iv = crypto.randomBytes(12);
        const cipher = crypto.createCipheriv('aes-256-gcm', key, iv);
        const encrypted = Buffer.concat([cipher.update(JSON.stringify(data), 'utf8'), cipher.final()]);
        return {
            encryptedData: encrypted.toString('base64'),
            iv,
            tag: cipher.getAuthTag(),
        };
    }
    async decryptField(encryptedData, key, iv, tag) {
        const decipher = crypto.createDecipheriv('aes-256-gcm', key, iv);
        decipher.setAuthTag(tag);
        const decrypted = Buffer.concat([
            decipher.update(Buffer.from(encryptedData, 'base64')),
            decipher.final(),
        ]);
        return JSON.parse(decrypted.toString('utf8'));
    }
}
exports.FieldEncryption = FieldEncryption;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmllbGRFbmNyeXB0aW9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZmllbGRFbmNyeXB0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLHFDQUE4QjtBQUM5QixpQ0FBaUM7QUFFakMsTUFBYSxlQUFlO0lBSTFCLFlBQVksS0FBYTtRQUN2QixJQUFJLENBQUMsR0FBRyxHQUFHLElBQUksYUFBRyxFQUFFLENBQUM7UUFDckIsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7SUFDckIsQ0FBQztJQUVEOztPQUVHO0lBQ0gsS0FBSyxDQUFDLGFBQWEsQ0FDakIsSUFBTyxFQUNQLGVBQXlCO1FBRXpCLE1BQU0sT0FBTyxHQUFHLE1BQU0sSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO1FBQzdDLE1BQU0sYUFBYSxHQUFHLEVBQUUsR0FBRyxJQUFJLEVBQUUsQ0FBQztRQUVsQyxLQUFLLE1BQU0sS0FBSyxJQUFJLGVBQWUsRUFBRSxDQUFDO1lBQ3BDLElBQUksS0FBSyxJQUFJLElBQUksRUFBRSxDQUFDO2dCQUNsQixNQUFNLFNBQVMsR0FBRyxNQUFNLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxFQUFFLE9BQU8sQ0FBQyxTQUFtQixDQUFDLENBQUM7Z0JBQ3BGLGFBQWEsQ0FBQyxLQUFLLENBQUMsR0FBRztvQkFDckIsU0FBUyxFQUFFLFNBQVMsQ0FBQyxhQUFhO29CQUNsQyxFQUFFLEVBQUUsU0FBUyxDQUFDLEVBQUUsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDO29CQUNuQyxHQUFHLEVBQUUsU0FBUyxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDO29CQUNyQyxZQUFZLEVBQUUsT0FBTyxDQUFDLGNBQWMsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDO2lCQUN4RCxDQUFDO1lBQ0osQ0FBQztRQUNILENBQUM7UUFFRCxPQUFPLGFBQWEsQ0FBQztJQUN2QixDQUFDO0lBRUQ7O09BRUc7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T0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztJQUNoRCxDQUFDO0NBQ0Y7QUF4SEQsMENBd0hDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgS01TIH0gZnJvbSAnYXdzLXNkayc7XG5pbXBvcnQgKiBhcyBjcnlwdG8gZnJvbSAnY3J5cHRvJztcblxuZXhwb3J0IGNsYXNzIEZpZWxkRW5jcnlwdGlvbiB7XG4gIHByaXZhdGUgcmVhZG9ubHkga21zOiBLTVM7XG4gIHByaXZhdGUgcmVhZG9ubHkga2V5SWQ6IHN0cmluZztcblxuICBjb25zdHJ1Y3RvcihrZXlJZDogc3RyaW5nKSB7XG4gICAgdGhpcy5rbXMgPSBuZXcgS01TKCk7XG4gICAgdGhpcy5rZXlJZCA9IGtleUlkO1xuICB9XG5cbiAgLyoqXG4gICAqIEVuY3J5cHRzIHNlbnNpdGl2ZSBmaWVsZHMgaW4gYW4gb2JqZWN0IHVzaW5nIEtNUyBhbmQgQUVTLTI1Ni1HQ01cbiAgICovXG4gIGFzeW5jIGVuY3J5cHRGaWVsZHM8VCBleHRlbmRzIFJlY29yZDxzdHJpbmcsIGFueT4+KFxuICAgIGRhdGE6IFQsXG4gICAgc2Vuc2l0aXZlRmllbGRzOiBzdHJpbmdbXVxuICApOiBQcm9taXNlPFQ+IHtcbiAgICBjb25zdCBkYXRhS2V5ID0gYXdhaXQgdGhpcy5nZW5lcmF0ZURhdGFLZXkoKTtcbiAgICBjb25zdCBlbmNyeXB0ZWREYXRhID0geyAuLi5kYXRhIH07XG5cbiAgICBmb3IgKGNvbnN0IGZpZWxkIG9mIHNlbnNpdGl2ZUZpZWxkcykge1xuICAgICAgaWYgKGZpZWxkIGluIGRhdGEpIHtcbiAgICAgICAgY29uc3QgZW5jcnlwdGVkID0gYXdhaXQgdGhpcy5lbmNyeXB0RmllbGQoZGF0YVtmaWVsZF0sIGRhdGFLZXkuUGxhaW50ZXh0IGFzIEJ1ZmZlcik7XG4gICAgICAgIGVuY3J5cHRlZERhdGFbZmllbGRdID0ge1xuICAgICAgICAgIGVuY3J5cHRlZDogZW5jcnlwdGVkLmVuY3J5cHRlZERhdGEsXG4gICAgICAgICAgaXY6IGVuY3J5cHRlZC5pdi50b1N0cmluZygnYmFzZTY0JyksXG4gICAgICAgICAgdGFnOiBlbmNyeXB0ZWQudGFnLnRvU3RyaW5nKCdiYXNlNjQnKSxcbiAgICAgICAgICBlbmNyeXB0ZWRLZXk6IGRhdGFLZXkuQ2lwaGVydGV4dEJsb2IudG9TdHJpbmcoJ2Jhc2U2NCcpLFxuICAgICAgICB9O1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBlbmNyeXB0ZWREYXRhO1xuICB9XG5cbiAgLyoqXG4gICAqIERlY3J5cHRzIHNlbnNpdGl2ZSBmaWVsZHMgaW4gYW4gb2JqZWN0IHVzaW5nIEtNUyBhbmQgQUVTLTI1Ni1HQ01cbiAgICovXG4gIGFzeW5jIGRlY3J5cHRGaWVsZHM8VCBleHRlbmRzIFJlY29yZDxzdHJpbmcsIGFueT4+KFxuICAgIGRhdGE6IFQsXG4gICAgc2Vuc2l0aXZlRmllbGRzOiBzdHJpbmdbXVxuICApOiBQcm9taXNlPFQ+IHtcbiAgICBjb25zdCBkZWNyeXB0ZWREYXRhID0geyAuLi5kYXRhIH07XG5cbiAgICBmb3IgKGNvbnN0IGZpZWxkIG9mIHNlbnNpdGl2ZUZpZWxkcykge1xuICAgICAgaWYgKGZpZWxkIGluIGRhdGEgJiYgdHlwZW9mIGRhdGFbZmllbGRdID09PSAnb2JqZWN0Jykge1xuICAgICAgICBjb25zdCBlbmNyeXB0ZWRGaWVsZCA9IGRhdGFbZmllbGRdO1xuICAgICAgICBjb25zdCBkYXRhS2V5ID0gYXdhaXQgdGhpcy5kZWNyeXB0RGF0YUtleShcbiAgICAgICAgICBCdWZmZXIuZnJvbShlbmNyeXB0ZWRGaWVsZC5lbmNyeXB0ZWRLZXksICdiYXNlNjQnKVxuICAgICAgICApO1xuXG4gICAgICAgIGNvbnN0IGRlY3J5cHRlZCA9IGF3YWl0IHRoaXMuZGVjcnlwdEZpZWxkKFxuICAgICAgICAgIGVuY3J5cHRlZEZpZWxkLmVuY3J5cHRlZCxcbiAgICAgICAgICBkYXRhS2V5LFxuICAgICAgICAgIEJ1ZmZlci5mcm9tKGVuY3J5cHRlZEZpZWxkLml2LCAnYmFzZTY0JyksXG4gICAgICAgICAgQnVmZmVyLmZyb20oZW5jcnlwdGVkRmllbGQudGFnLCAnYmFzZTY0JylcbiAgICAgICAgKTtcblxuICAgICAgICBkZWNyeXB0ZWREYXRhW2ZpZWxkXSA9IGRlY3J5cHRlZDtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gZGVjcnlwdGVkRGF0YTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZ2VuZXJhdGVEYXRhS2V5KCk6IFByb21pc2U8S01TLkdlbmVyYXRlRGF0YUtleVJlc3BvbnNlPiB7XG4gICAgcmV0dXJuIHRoaXMua21zXG4gICAgICAuZ2VuZXJhdGVEYXRhS2V5KHtcbiAgICAgICAgS2V5SWQ6IHRoaXMua2V5SWQsXG4gICAgICAgIEtleVNwZWM6ICdBRVNfMjU2JyxcbiAgICAgIH0pXG4gICAgICAucHJvbWlzZSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBkZWNyeXB0RGF0YUtleShlbmNyeXB0ZWRLZXk6IEJ1ZmZlcik6IFByb21pc2U8QnVmZmVyPiB7XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLmttc1xuICAgICAgLmRlY3J5cHQoe1xuICAgICAgICBDaXBoZXJ0ZXh0QmxvYjogZW5jcnlwdGVkS2V5LFxuICAgICAgICBLZXlJZDogdGhpcy5rZXlJZCxcbiAgICAgIH0pXG4gICAgICAucHJvbWlzZSgpO1xuXG4gICAgcmV0dXJuIHJlc3BvbnNlLlBsYWludGV4dCBhcyBCdWZmZXI7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGVuY3J5cHRGaWVsZChcbiAgICBkYXRhOiBhbnksXG4gICAga2V5OiBCdWZmZXJcbiAgKTogUHJvbWlzZTx7XG4gICAgZW5jcnlwdGVkRGF0YTogc3RyaW5nO1xuICAgIGl2OiBCdWZmZXI7XG4gICAgdGFnOiBCdWZmZXI7XG4gIH0+IHtcbiAgICBjb25zdCBpdiA9IGNyeXB0by5yYW5kb21CeXRlcygxMik7XG4gICAgY29uc3QgY2lwaGVyID0gY3J5cHRvLmNyZWF0ZUNpcGhlcml2KCdhZXMtMjU2LWdjbScsIGtleSwgaXYpO1xuXG4gICAgY29uc3QgZW5jcnlwdGVkID0gQnVmZmVyLmNvbmNhdChbY2lwaGVyLnVwZGF0ZShKU09OLnN0cmluZ2lmeShkYXRhKSwgJ3V0ZjgnKSwgY2lwaGVyLmZpbmFsKCldKTtcblxuICAgIHJldHVybiB7XG4gICAgICBlbmNyeXB0ZWREYXRhOiBlbmNyeXB0ZWQudG9TdHJpbmcoJ2Jhc2U2NCcpLFxuICAgICAgaXYsXG4gICAgICB0YWc6IGNpcGhlci5nZXRBdXRoVGFnKCksXG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZGVjcnlwdEZpZWxkKFxuICAgIGVuY3J5cHRlZERhdGE6IHN0cmluZyxcbiAgICBrZXk6IEJ1ZmZlcixcbiAgICBpdjogQnVmZmVyLFxuICAgIHRhZzogQnVmZmVyXG4gICk6IFByb21pc2U8YW55PiB7XG4gICAgY29uc3QgZGVjaXBoZXIgPSBjcnlwdG8uY3JlYXRlRGVjaXBoZXJpdignYWVzLTI1Ni1nY20nLCBrZXksIGl2KTtcbiAgICBkZWNpcGhlci5zZXRBdXRoVGFnKHRhZyk7XG5cbiAgICBjb25zdCBkZWNyeXB0ZWQgPSBCdWZmZXIuY29uY2F0KFtcbiAgICAgIGRlY2lwaGVyLnVwZGF0ZShCdWZmZXIuZnJvbShlbmNyeXB0ZWREYXRhLCAnYmFzZTY0JykpLFxuICAgICAgZGVjaXBoZXIuZmluYWwoKSxcbiAgICBdKTtcblxuICAgIHJldHVybiBKU09OLnBhcnNlKGRlY3J5cHRlZC50b1N0cmluZygndXRmOCcpKTtcbiAgfVxufVxuIl19